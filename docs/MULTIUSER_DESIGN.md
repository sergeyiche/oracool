# üîÄ –ú–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

**–í–µ—Ä—Å–∏—è:** 1.0.0  
**–î–∞—Ç–∞:** 2026-01-23

---

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–û–±–∑–æ—Ä](#–æ–±–∑–æ—Ä)
2. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-–¥–∞–Ω–Ω—ã—Ö)
3. [–ò–∑–æ–ª—è—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π](#–∏–∑–æ–ª—è—Ü–∏—è-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
4. [–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º](#—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ-–∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º)
5. [API –∫–æ–º–∞–Ω–¥](#api-–∫–æ–º–∞–Ω–¥)
6. [–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è](#–ø—Ä–∏–º–µ—Ä—ã-–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)

---

## üéØ –û–±–∑–æ—Ä

### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

**–ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- ‚úÖ –û–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –æ–±—â–∞—Ç—å—Å—è —Å –±–æ—Ç–æ–º
- ‚úÖ RAG –Ω–∞—Ö–æ–¥–∏—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
- ‚úÖ LLM –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç—ã
- ‚úÖ –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–∞ –ø–æ user_id

**–ß—Ç–æ –Ω—É–∂–Ω–æ:**
- ‚ùå –•—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–æ–≤
- ‚ùå –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- ‚ùå –ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚ùå –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏—è–º–∏ (–Ω–∞—á–∞—Ç—å –Ω–æ–≤—ã–π –¥–∏–∞–ª–æ–≥, –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å, –æ—á–∏—Å—Ç–∏—Ç—å)

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

### –£—Ä–æ–≤–µ–Ω—å 1: Users (–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏)

```
user_profiles (—É–∂–µ –µ—Å—Ç—å)
‚îú‚îÄ‚îÄ id (UUID)
‚îú‚îÄ‚îÄ user_id (VARCHAR) ‚Üê Telegram ID
‚îú‚îÄ‚îÄ communication_style
‚îú‚îÄ‚îÄ response_length
‚îú‚îÄ‚îÄ relevance_threshold
‚îî‚îÄ‚îÄ ...
```

**–†–æ–ª—å:** –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

---

### –£—Ä–æ–≤–µ–Ω—å 2: Conversations (–°–µ—Å—Å–∏–∏ –¥–∏–∞–ª–æ–≥–æ–≤)

```sql
CREATE TABLE conversations (
    id UUID PRIMARY KEY,
    user_id VARCHAR(255) NOT NULL,           -- Telegram user ID
    chat_id BIGINT NOT NULL,                  -- Telegram chat ID
    title VARCHAR(255),                       -- "–û —Å–º—ã—Å–ª–µ –∂–∏–∑–Ω–∏", "–†–∞–±–æ—Ç–∞ —Å —Ç–µ–Ω—å—é"
    status VARCHAR(20) DEFAULT 'active',      -- active, archived, deleted
    context_summary TEXT,                     -- –†–µ–∑—é–º–µ –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤
    message_count INTEGER DEFAULT 0,
    last_message_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    
    UNIQUE(user_id, chat_id)  -- –æ–¥–∏–Ω –∞–∫—Ç–∏–≤–Ω—ã–π –¥–∏–∞–ª–æ–≥ –Ω–∞ —á–∞—Ç
);
```

**–†–æ–ª—å:** –°–µ—Å—Å–∏—è –¥–∏–∞–ª–æ–≥–∞ –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –∏ –±–æ—Ç–æ–º

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –û–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí –º–Ω–æ–≥–æ conversations (–≤ —Ä–∞–∑–Ω—ã—Ö —á–∞—Ç–∞—Ö –∏–ª–∏ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ)
- Conversation –º–æ–∂–µ—Ç –±—ã—Ç—å archived (–¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏)
- `context_summary` - –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–µ–º—ã –¥–∏–∞–ª–æ–≥–∞ (–¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤)

---

### –£—Ä–æ–≤–µ–Ω—å 3: Messages (–°–æ–æ–±—â–µ–Ω–∏—è)

```sql
CREATE TABLE messages (
    id UUID PRIMARY KEY,
    conversation_id UUID REFERENCES conversations(id) ON DELETE CASCADE,
    
    -- –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è
    external_message_id BIGINT,              -- Telegram message_id
    direction VARCHAR(10) NOT NULL,          -- 'incoming' or 'outgoing'
    
    -- –ö–æ–Ω—Ç–µ–Ω—Ç
    content_type VARCHAR(50) DEFAULT 'text', -- text, image, voice
    content TEXT NOT NULL,
    
    -- RAG –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (—Ç–æ–ª—å–∫–æ –¥–ª—è outgoing)
    relevance_score FLOAT,                   -- –†–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    context_entries_used INTEGER,            -- –°–∫–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–µ–π –∏–∑ KB –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ
    processing_time_ms INTEGER,              -- –í—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
    
    -- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    metadata JSONB DEFAULT '{}',             -- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    created_at TIMESTAMPTZ DEFAULT NOW(),
    
    -- –ò–Ω–¥–µ–∫—Å—ã
    INDEX idx_messages_conversation (conversation_id, created_at DESC),
    INDEX idx_messages_external (external_message_id)
);
```

**–†–æ–ª—å:** –û—Ç–¥–µ–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Ä–∞–º–∫–∞—Ö conversation

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- `direction: incoming` - —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `direction: outgoing` - –æ—Ç–≤–µ—Ç –±–æ—Ç–∞
- RAG –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∫–∞—á–µ—Å—Ç–≤–∞

---

## üîí –ò–∑–æ–ª—è—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### –ü—Ä–∏–Ω—Ü–∏–ø: –∫–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ

```
User A (telegram_id: 12345)
‚îú‚îÄ‚îÄ user_profiles (id: 12345)
‚îú‚îÄ‚îÄ knowledge_base (user_id: 12345)
‚îÇ   ‚îú‚îÄ‚îÄ –ó–∞–ø–∏—Å—å 1: "–°—Ç–æ–∏—Ü–∏–∑–º..."
‚îÇ   ‚îú‚îÄ‚îÄ –ó–∞–ø–∏—Å—å 2: "–Æ–Ω–≥..."
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îî‚îÄ‚îÄ conversations (user_id: 12345)
    ‚îú‚îÄ‚îÄ Conversation 1 (chat_id: 67890)
    ‚îÇ   ‚îú‚îÄ‚îÄ Message 1 (incoming): "–ü—Ä–∏–≤–µ—Ç"
    ‚îÇ   ‚îú‚îÄ‚îÄ Message 2 (outgoing): "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π!"
    ‚îÇ   ‚îî‚îÄ‚îÄ ...
    ‚îî‚îÄ‚îÄ Conversation 2 (chat_id: 11111)
        ‚îî‚îÄ‚îÄ ...

User B (telegram_id: 54321)
‚îú‚îÄ‚îÄ user_profiles (id: 54321)
‚îú‚îÄ‚îÄ knowledge_base (user_id: 54321)  ‚Üê –°–í–û–Ø –±–∞–∑–∞
‚îî‚îÄ‚îÄ conversations (user_id: 54321)   ‚Üê –°–í–û–ò –¥–∏–∞–ª–æ–≥–∏
```

**–ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã:**
- ‚úÖ –ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–º–µ–µ—Ç —Å–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å
- ‚úÖ –ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–º–µ–µ—Ç —Å–≤–æ—é –±–∞–∑—É –∑–Ω–∞–Ω–∏–π
- ‚úÖ –ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –¥–∏–∞–ª–æ–≥–∏
- ‚úÖ –ë–æ—Ç—ã —Ä–∞–∑–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ù–ï –¥–µ–ª—è—Ç—Å—è –∑–Ω–∞–Ω–∏—è–º–∏

---

## üß† –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º

### –ü—Ä–æ–±–ª–µ–º–∞: –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ä–∞—Å—Ç—ë—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ

**–†–µ—à–µ–Ω–∏–µ: Sliding Window + Summarization**

```
–î–∏–∞–ª–æ–≥ (50 —Å–æ–æ–±—â–µ–Ω–∏–π)
‚îÇ
‚îú‚îÄ‚îÄ –°—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (1-40)  ‚Üí Summarization
‚îÇ   "–û–±—Å—É–∂–¥–∞–ª–∏: —ç–∫–∑–∏—Å—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –∫—Ä–∏–∑–∏—Å, –ø–æ–∏—Å–∫ —Å–º—ã—Å–ª–∞"
‚îÇ
‚îî‚îÄ‚îÄ –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è (41-50) ‚Üí Full context
    ‚îú‚îÄ‚îÄ Message 41: "–ö–∞–∫ –Ω–∞–π—Ç–∏ —Å–º—ã—Å–ª?"
    ‚îú‚îÄ‚îÄ Message 42: "–í–∏–∫—Ç–æ—Ä –§—Ä–∞–Ω–∫–ª..."
    ‚îî‚îÄ‚îÄ ...
```

### –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º

#### 1. Sliding Window (–ø—Ä–æ—Å—Ç–∞—è)

```php
// –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å–æ–æ–±—â–µ–Ω–∏–π
$context = $conversationRepo->getRecentMessages(
    conversationId: $conversationId,
    limit: 10  // –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–æ–æ–±—â–µ–Ω–∏–π
);
```

**–ü–ª—é—Å—ã:**
- –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
- –ü—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏
- –ë—ã—Å—Ç—Ä–æ

**–ú–∏–Ω—É—Å—ã:**
- –¢–µ—Ä—è–µ—Ç—Å—è –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å—Ç–∞—Ä—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

---

#### 2. Summarization (–ø—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è)

```php
// –î–ª—è –¥–∏–∞–ª–æ–≥–æ–≤ >20 —Å–æ–æ–±—â–µ–Ω–∏–π
if ($messageCount > 20) {
    // –†–µ–∑—é–º–µ —Å—Ç–∞—Ä—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    $summary = $conversationRepo->getContextSummary($conversationId);
    
    // + –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å–æ–æ–±—â–µ–Ω–∏–π
    $recentMessages = $conversationRepo->getRecentMessages($conversationId, 10);
    
    $fullContext = [
        ['role' => 'system', 'content' => "–ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞: $summary"],
        ...$recentMessages
    ];
}
```

**–ü–ª—é—Å—ã:**
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤–µ—Å—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞
- –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤

**–ú–∏–Ω—É—Å—ã:**
- –¢—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π LLM –≤—ã–∑–æ–≤ –¥–ª—è summarization

---

#### 3. –í–∞–∂–Ω–æ—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π (advanced)

```php
// –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è —Å –≤–µ—Å–∞–º–∏ –≤–∞–∂–Ω–æ—Å—Ç–∏
$context = $conversationRepo->getImportantMessages(
    conversationId: $conversationId,
    importanceThreshold: 0.7,
    limit: 15
);
```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤–∞–∂–Ω–æ—Å—Ç–∏:**
- –†–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å –∫ —Ç–µ–∫—É—â–µ–º—É –≤–æ–ø—Ä–æ—Å—É
- –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –∑–Ω–∞—á–∏–º–æ—Å—Ç—å
- –ö–ª—é—á–µ–≤—ã–µ –∏–Ω—Å–∞–π—Ç—ã

---

## üìä –°—Ö–µ–º–∞ —Ä–∞–±–æ—Ç—ã

### –í—Ö–æ–¥—è—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç User A

```
1. Telegram Webhook
   ‚Üì
2. TelegramWebhookController
   ‚Üì user_id: 12345, chat_id: 67890, text: "–ö–∞–∫ –Ω–∞–π—Ç–∏ —Å–º—ã—Å–ª?"
   ‚Üì
3. ConversationRepository::getOrCreateConversation(12345, 67890)
   ‚Üì conversation_id: abc-123
   ‚Üì
4. ConversationRepository::saveMessage(
      conversation_id: abc-123,
      direction: 'incoming',
      content: "–ö–∞–∫ –Ω–∞–π—Ç–∏ —Å–º—ã—Å–ª?"
   )
   ‚Üì
5. ConversationRepository::getRecentMessages(abc-123, limit: 10)
   ‚Üì $conversationHistory
   ‚Üì
6. GenerateResponse::execute(
      message: "–ö–∞–∫ –Ω–∞–π—Ç–∏ —Å–º—ã—Å–ª?",
      profile: UserProfile(12345),
      conversationHistory: $conversationHistory  ‚Üê –ö–û–ù–¢–ï–ö–°–¢!
   )
   ‚Üì $response
   ‚Üì
7. ConversationRepository::saveMessage(
      conversation_id: abc-123,
      direction: 'outgoing',
      content: $response,
      relevance_score: 0.86,
      context_entries_used: 5
   )
   ‚Üì
8. TelegramService::sendMessage(chat_id: 67890, text: $response)
```

---

## üõ†Ô∏è API –∫–æ–º–∞–Ω–¥

### 1. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞–º–∏

```bash
# –°–ø–∏—Å–æ–∫ –¥–∏–∞–ª–æ–≥–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
docker exec oracool-app php bin/console conversation:list YOUR_TELEGRAM_ID

# –ü—Ä–æ—Å–º–æ—Ç—Ä –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞
docker exec oracool-app php bin/console conversation:show CONVERSATION_ID

# –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é (–Ω–∞—á–∞—Ç—å –Ω–æ–≤—ã–π –¥–∏–∞–ª–æ–≥)
docker exec oracool-app php bin/console conversation:clear YOUR_TELEGRAM_ID CHAT_ID

# –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å –¥–∏–∞–ª–æ–≥
docker exec oracool-app php bin/console conversation:archive CONVERSATION_ID

# –≠–∫—Å–ø–æ—Ä—Ç –¥–∏–∞–ª–æ–≥–∞
docker exec oracool-app php bin/console conversation:export CONVERSATION_ID \
  --format=json --output=/path/to/export.json
```

---

### 2. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

```bash
# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
docker exec oracool-app php bin/console stats:user YOUR_TELEGRAM_ID

# –†–µ–∑—É–ª—å—Ç–∞—Ç:
# ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
# ‚îÇ –ú–µ—Ç—Ä–∏–∫–∞                     ‚îÇ –ó–Ω–∞—á–µ–Ω–∏–µ ‚îÇ
# ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
# ‚îÇ –í—Å–µ–≥–æ –¥–∏–∞–ª–æ–≥–æ–≤              ‚îÇ 5        ‚îÇ
# ‚îÇ –ê–∫—Ç–∏–≤–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤           ‚îÇ 2        ‚îÇ
# ‚îÇ –í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π             ‚îÇ 127      ‚îÇ
# ‚îÇ –°—Ä–µ–¥–Ω—è—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å       ‚îÇ 82.3%    ‚îÇ
# ‚îÇ –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞        ‚îÇ 3.2 —Å–µ–∫  ‚îÇ
# ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üí° –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ü–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```
User: 858361483 ‚Üí "–ü—Ä–∏–≤–µ—Ç"
Chat: 123456789

–°–∏—Å—Ç–µ–º–∞:
1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç user_profile (–µ—Å–ª–∏ –Ω–µ—Ç ‚Üí —Å–æ–∑–¥–∞—ë—Ç)
2. –°–æ–∑–¥–∞—ë—Ç conversation (user_id: 858361483, chat_id: 123456789)
3. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç message (direction: incoming, content: "–ü—Ä–∏–≤–µ—Ç")
4. conversationHistory = [] (–ø—É—Å—Ç–∞—è –∏—Å—Ç–æ—Ä–∏—è)
5. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç —Å –ø—É—Å—Ç—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
6. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç message (direction: outgoing, content: "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π!")
```

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞

```
User: 858361483 ‚Üí "–ö–∞–∫ –Ω–∞–π—Ç–∏ —Å–º—ã—Å–ª –∂–∏–∑–Ω–∏?"
Chat: 123456789

–°–∏—Å—Ç–µ–º–∞:
1. –ù–∞—Ö–æ–¥–∏—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π conversation (user_id + chat_id)
2. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç incoming message
3. conversationHistory = [
     {role: 'user', content: '–ü—Ä–∏–≤–µ—Ç'},
     {role: 'assistant', content: '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π!'}
   ] ‚Üê –ö–û–ù–¢–ï–ö–°–¢ –ò–ó –ë–î!
4. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç —Å —É—á—ë—Ç–æ–º –∏—Å—Ç–æ—Ä–∏–∏
5. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç outgoing message
```

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –î–ª–∏–Ω–Ω—ã–π –¥–∏–∞–ª–æ–≥ (>20 —Å–æ–æ–±—â–µ–Ω–∏–π)

```
User: 858361483 ‚Üí "–†–∞—Å—Å–∫–∞–∂–∏ –µ—â—ë"
Chat: 123456789
Message count: 35

–°–∏—Å—Ç–µ–º–∞:
1. –ù–∞—Ö–æ–¥–∏—Ç conversation
2. context_summary = "–û–±—Å—É–∂–¥–∞–ª–∏: —ç–∫–∑–∏—Å—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –∫—Ä–∏–∑–∏—Å, —Å–º—ã—Å–ª –∂–∏–∑–Ω–∏, –§—Ä–∞–Ω–∫–ª"
3. conversationHistory = [
     {role: 'system', content: '–ö–æ–Ω—Ç–µ–∫—Å—Ç: ' + context_summary},
     ...–ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–æ–æ–±—â–µ–Ω–∏–π
   ]
4. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç —Å —É—á—ë—Ç–æ–º summary + recent
```

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 4: –ú–Ω–æ–∂–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ

```
–û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ:
- User A (12345) –≤ Chat 111 ‚Üí "–ß—Ç–æ —Ç–∞–∫–æ–µ —Ç–µ–Ω—å?"
- User B (54321) –≤ Chat 222 ‚Üí "–ö–∞–∫ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å —ç–º–æ—Ü–∏–∏?"
- User C (99999) –≤ Chat 333 ‚Üí "–ú–Ω–µ –≥—Ä—É—Å—Ç–Ω–æ"

–°–∏—Å—Ç–µ–º–∞:
‚îú‚îÄ‚îÄ Conversation A (user: 12345, chat: 111)
‚îÇ   ‚îú‚îÄ‚îÄ –ò—Å—Ç–æ—Ä–∏—è A (–Ω–µ –ø–µ—Ä–µ—Å–µ–∫–∞–µ—Ç—Å—è —Å B –∏ C)
‚îÇ   ‚îî‚îÄ‚îÄ Knowledge Base A (—Ç–æ–ª—å–∫–æ –¥–ª—è User A)
‚îÇ
‚îú‚îÄ‚îÄ Conversation B (user: 54321, chat: 222)
‚îÇ   ‚îú‚îÄ‚îÄ –ò—Å—Ç–æ—Ä–∏—è B (–Ω–µ –ø–µ—Ä–µ—Å–µ–∫–∞–µ—Ç—Å—è —Å A –∏ C)
‚îÇ   ‚îî‚îÄ‚îÄ Knowledge Base B (—Ç–æ–ª—å–∫–æ –¥–ª—è User B)
‚îÇ
‚îî‚îÄ‚îÄ Conversation C (user: 99999, chat: 333)
    ‚îú‚îÄ‚îÄ –ò—Å—Ç–æ—Ä–∏—è C (–Ω–µ –ø–µ—Ä–µ—Å–µ–∫–∞–µ—Ç—Å—è —Å A –∏ B)
    ‚îî‚îÄ‚îÄ Knowledge Base C (—Ç–æ–ª—å–∫–æ –¥–ª—è User C)

‚úÖ –ü–æ–ª–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏—è!
```

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 5: –û—á–∏—Å—Ç–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

```bash
# –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç –Ω–∞—á–∞—Ç—å –Ω–æ–≤—ã–π –¥–∏–∞–ª–æ–≥ –Ω–∞ –¥—Ä—É–≥—É—é —Ç–µ–º—É
docker exec oracool-app php bin/console conversation:clear 858361483 123456789

–†–µ–∑—É–ª—å—Ç–∞—Ç:
- –°—Ç–∞—Ä—ã–π conversation ‚Üí archived
- –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π conversation (–ø—É—Å—Ç–∞—è –∏—Å—Ç–æ—Ä–∏—è)
- –°–ª–µ–¥—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞—á–Ω—ë—Ç –¥–∏–∞–ª–æ–≥ —Å —á–∏—Å—Ç–æ–≥–æ –ª–∏—Å—Ç–∞
```

---

## üîÑ –ú–∏–≥—Ä–∞—Ü–∏—è —Å —Ç–µ–∫—É—â–µ–π —Å—Ö–µ–º—ã

### –¢–µ–∫—É—â–∞—è —Ç–∞–±–ª–∏—Ü–∞ messages (—É–ø—Ä–æ—â—ë–Ω–Ω–∞—è)

```sql
-- –°—Ç–∞—Ä–∞—è (–Ω–µ—Ç conversation_id, –Ω–µ—Ç direction)
CREATE TABLE messages (
    id UUID,
    user_id VARCHAR(255),
    chat_id BIGINT,
    message_id BIGINT,
    text TEXT,
    metadata JSONB
);
```

### –ü–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏

1. **–°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É conversations**
2. **–û–±–Ω–æ–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É messages**:
   - –î–æ–±–∞–≤–∏—Ç—å `conversation_id`
   - –î–æ–±–∞–≤–∏—Ç—å `direction`
   - –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å `text` ‚Üí `content`
   - –î–æ–±–∞–≤–∏—Ç—å `content_type`
3. **–°–æ–∑–¥–∞—Ç—å conversation –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ (user_id, chat_id)**
4. **–û–±–Ω–æ–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ messages —Å conversation_id**

---

## üìà –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

**–ó–∞–ø—Ä–æ—Å—ã:**
- `getOrCreateConversation`: O(1) —Å –∏–Ω–¥–µ–∫—Å–æ–º `(user_id, chat_id)`
- `getRecentMessages`: O(log N) —Å –∏–Ω–¥–µ–∫—Å–æ–º `(conversation_id, created_at DESC)`
- `saveMessage`: O(1)

**–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**
- –ò–Ω–¥–µ–∫—Å—ã –Ω–∞ `(conversation_id, created_at)`
- –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ `created_at` (–¥–ª—è –º–∏–ª–ª–∏–æ–Ω–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π)
- –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∞—Å—Ç—ã—Ö conversations –≤ Redis

---

### –õ–∏–º–∏—Ç—ã

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ | –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ |
|----------|----------|-------------|
| Max messages per conversation | 1000 | –ü–æ—Å–ª–µ ‚Üí summarization |
| Sliding window size | 10-20 | –ë–∞–ª–∞–Ω—Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞/—Ç–æ–∫–µ–Ω–æ–≤ |
| Max active conversations per user | 10 | –û—Å—Ç–∞–ª—å–Ω—ã–µ ‚Üí archived |
| Message retention | 1 –≥–æ–¥ | –ü–æ—Å–ª–µ ‚Üí archived/deleted |

---

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### Phase 1: –ë–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (—Å–µ–π—á–∞—Å)
- [ ] –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é conversations
- [ ] –û–±–Ω–æ–≤–∏—Ç—å messages —Ç–∞–±–ª–∏—Ü—É
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å ConversationRepository
- [ ] –û–±–Ω–æ–≤–∏—Ç—å TelegramWebhookController
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å 2-3 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏

### Phase 2: Context Management
- [ ] Sliding window
- [ ] Summarization –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤
- [ ] –ö–æ–º–∞–Ω–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞–º–∏

### Phase 3: Advanced Features
- [ ] Importance scoring
- [ ] Multi-session support (–Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–∏–∞–ª–æ–≥–æ–≤ –æ—Ç –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
- [ ] Analytics (—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –¥–∏–∞–ª–æ–≥–∞–º)

---

## üìö –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- `docs/DEPLOYMENT.md` - —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ
- `docs/AI_SETUP.md` - –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ AI
- `docs/TRAINING.md` - –æ–±—É—á–µ–Ω–∏–µ –±–æ—Ç–∞

---

**–í–µ—Ä—Å–∏—è:** 1.0.0  
**–î–∞—Ç–∞:** 2026-01-23  
**–°—Ç–∞—Ç—É—Å:** üöß –í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ
