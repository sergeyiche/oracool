┌─────────────────────────────────────────────────────────────┐
│                    Внешний мир (мессенджеры)                │
└─────────────────┬─────────────────┬─────────────────────────┘
                  │                 │
           Telegram Webhook   WhatsApp Webhook
                  │                 │
┌─────────────────▼─────────────────▼─────────────────────────┐
│                Входные адаптеры (Primary Adapters)          │
├─────────────────────────────────────────────────────────────┤
│  Telegram Controller    WhatsApp Controller    REST API      │
└─────────────────┬─────────────────┬─────────────────────────┘
                  │                 │
                  └───────┬─────────┘
                          │
┌─────────────────────────▼───────────────────────────────────┐
│                Ядро приложения (Application Core)           │
├─────────────────────────────────────────────────────────────┤
│  Use Cases / Services:                                      │
│  1. MessageReceiver     → Приём сообщений                   │
│  2. IntentRecognizer    → Определение намерения             │
│  3. ContextManager      → Управление контекстом диалога     │
│  4. AIOrchestrator      → Оркестрация ИИ-моделей           │
│  5. ResponseBuilder     → Формирование ответа               │
└─────────────────────────┬───────────────────────────────────┘
                          │
┌─────────────────────────▼───────────────────────────────────┐
│                Выходные адаптеры (Secondary Adapters)       │
├─────────────────────────────────────────────────────────────┤
│  ├── AI Providers:                                          │
│  │   • OpenAI GPT-4                                        │
│  │   • Anthropic Claude                                    │
│  │   • Local LLM (via Ollama)                              │
│  ├── Database: PostgreSQL + Doctrine                        │
│  ├── Cache: Redis (для контекста диалога)                   │
│  ├── Message Queue: RabbitMQ/SQS (для асинхронных задач)    │
└─────────────────────────────────────────────────────────────┘



Ключевые архитектурные решения:
Асинхронная обработка: Все сообщения идут через очередь, чтобы Telegram получал мгновенный ответ.

Мультибот поддержка: Одна система может обслуживать несколько ботов (продакшн, тестовый, разные языки).

Интенты (Intents): Классификация сообщений для разной логики обработки.

Контекст диалога: Хранение состояния разговора для персонализации.

Отказоустойчивость: Повторная обработка сообщений при ошибках.

Масштабируемость: Workers можно масштабировать горизонтально.

Следующие шаги после реализации:
Добавить кеширование контекста в Redis для быстрого доступа

Реализовать Circuit Breaker для внешних AI-сервисов

Добавить A/B тестирование разных ИИ-моделей

Внедрить аналитику диалогов (какие интенты чаще всего, satisfaction rate)

Реализовать механизм human-in-the-loop для сложных случаев



